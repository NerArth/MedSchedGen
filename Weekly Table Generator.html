<!DOCTYPE html>
<html lang="en-GB">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="NerArth">
    <meta name="keywords" content="Medication, Schedule, Generator, Titration, ADHD">
    <meta name="description" content="Generate medication-taking schedules which can then be printed off for real-world usage. Static HTML webpage, can be saved, downloaded and kept for future use even without an active internet connection.">
    <title>Medication Schedule Generator</title>
    <style>
      @media print{
        .noprint {
          display:none;
        }
      }
      body {
        font-family: Arial, sans-serif;
        text-align: center;
      }
      .controls {
        margin: 20px 0;
        border: 2px dashed grey;
        border-top-width: 4px;
        border-bottom-width: 4px;
      }
      .controls-sub {
        margin:6px;
        border: 1px lightgrey;
        border-style: ridge;
      }
      .controls-sub:not(#submitcontrols) {
        text-align: left;
      }
      input[type="date"], input[type="number"], select {
        padding: 4px;
        margin: 4px;
        border: 3px solid lightgrey;
        border-radius: 3px;
      }
      table {
        table-layout: fixed;
        width: 100%;
        margin: 20px auto;
        border-collapse: collapse;
      }
      th, td {
        border: 1px solid black;
        padding: 10px;
        text-align: center;
      }
      .header-week-outline {
        background-color: floralwhite;
        text-align: left;
        padding-top: 8px;
        padding-bottom: 5px;
      }
      .td-weekday {
        background-color: wheat;
        font-size: 0.75em;
        padding-top: 12px;
        padding-bottom: 5px;
      }
      tbody > tr > td{
        padding: 40px;
        padding-top: 4px;
        padding-left: 4px;
        text-align: left;
        font-size: 0.75em;
      }
      .dose-0{
        /*margin: 2px;
        width: 8px;
        height: 8px;
       	display: inline-block;
        border-width: 1px;
        border-style: solid;
        border-color: black;*/
      }/*
      .dose-1{
        margin: 2px;
        width: 8px;
        height: 8px;
       	display: inline-block;
        border-width: 1px;
        border-style: solid;
        border-color: black;
      }*/
      input:placeholder-shown {
        background-color: #ededed;
      }
      input:not(:placeholder-shown) {
        background-color: white;
      }
      select#weekdisplay-options {
        background-color: white;
      }
      select#weekdisplay-options option[value="none"] { 
        background-color: lightgrey;
        font-family: monospace;
        font-variant: small-caps;
      }
    </style>
  </head>
  <body>
    <div style="text-align:right; font-size:0.5em; font-family: monospace;">
      <span>
        This table was generated by a script. Source may be viewed at https://github.com/NerArth/MedSchedGen
      </span>
    </div>
    <h2 style="margin-top:0px;">Medication Schedule</h2>
    <div class="controls noprint">
      <h2 style="margin-bottom: 4px;">Settings</h2>
      <p style="text-align:center; margin-top: 0; font-size:0.75em;">
        <strong>NOTE:</strong> <i>Anything inside dashed boxes is not printed out in a physical document!</i>
      </p>
      <div id="datecontrols" class="controls-sub noprint" style="padding:10px">
        <label for="date-locale">Date format:</label><select name="date-locale" id="date-locale">
        	<option value="en-GB">UK/Europe - dd/mm/yyyy (en-GB)(default)</option>
        	<option value="en-US">USA - mm/dd/yyyy (en-US)</option>
        </select>
        <br>
        <label for="start-date">Start Date:</label><input id="start-date" type="date">
        <label for="end-date">End Date:</label><input id="end-date" type="date">
        <!-- <input type="checkbox" id="weekdisplay-toggle" name="weekoption" checked><label for="weekdisplay-toggle">Add "week starting on..."</label> -->
        <label for="weekdisplay-options">Time period label:</label><select name="weekdisplay" id="weekdisplay-options" placeholder="none">
          <option value="none" selected>(None)</option>
          <option value="custom" selected>Custom</option>
          <option value="weekstarting">Week starting on...</option>
        </select>
      </div>
      <div id="dosecontrols" class="controls-sub noprint" style="padding:10px">
        <label for="dose">Dosage (mg):</label><input id="dose" type="number" placeholder="n/a">
        <label for="dose-increment">Change (mg):</label><input id="dose-increment" type="number" placeholder="n/a">
        <br>
        <label for="dose-increment-times"># of dose changes:</label><input id="dose-increment-times" type="number" placeholder="n/a">
      	<label for="dose-period">Days on each dose:</label><input id="dose-period" type="number" placeholder="n/a">
      </div>
      <div id="submitcontrols" class="controls-sub noprint" style="padding:10px">
        <button onclick="generateFromInputs()">Generate Table</button>
      </div>
    </div>
    <div class="controls noprint" style="padding:10px; font-family:monospace; text-align:left; font-size:1.2em;">
      <details>
        <summary style="text-align:center;">Limitations & Tips/Usage</summary>
        <p>
          Right now, only a combined mg dose input is supported, for one medication. This means that if you had to take 75+75mg in a day, your "dosage" input should be 150mg.
        </p>
        <p>
          Leaving the medication inputs blank will generate a start-to-end calendar with your specified date range.
        </p>
        <p>
          The recommended way to use the weekly calendar is to print it out and then write the time at which medication was taken, especially if medication consists of taking more than a single dose in a day.
        </p>
        <p>
          Otherwise, simply mark the day with a cross, circle or tick as soon as the medication has been taken.
        </p>
        <details>
          <summary style="text-align:center;">Legal</summary>
          <p>This tool is provided as-is; please refer to the license on GitHub for more information.</p>
          <p>It is intended for personal use but may be freely used by anyone.</p>
        </details>
      </details>
    </div>
    <div id="table-container"> </div>
    <script>
      // To-do: Everything needs tidying up here. Just in a basic functioning state with little organisation because of the prototyping flow
      function generateWeeklyTables(startDate, endDate, dateLocale, weeklyDisplay, dose, doseIncrement, doseIncrementTimes, dosePeriod) {
        console.log(startDate,endDate,dateLocale,dose,doseIncrement,doseIncrementTimes,dosePeriod);
        const container = document.getElementById("table-container");
        const dateShort = {day:"numeric"};
        const dateShortMonth = {day:"numeric",month:"short"};
        const dateLong = {year:"numeric",month:"long",day:"numeric"};
        const dateWeekday = {weekday:"long"};
        container.innerHTML = ""; // Clear previous tables
        let currentDate = new Date(startDate);
        
        let table = document.createElement("table"); // The original script had this inside the while to make separate tables for each week
        
        // Make a weekday header before anything else
        let weekdays = document.createElement("thead");
        let weekdayRow = document.createElement("tr");
        let workingday = new Date();

        let isFirstDayCreated = false; // to-do, add functionality of showing the month on the very first day of the table, to make month clear
        
        for (let i = 0; i < 7; i++) {
          let weekdayCell = document.createElement("th");
          workingday.setDate(currentDate.getDate() + i);
          weekdayCell.textContent = `${workingday.toLocaleDateString(dateLocale,dateWeekday)}`;
          weekdayCell.className = "td-weekday";
          weekdayRow.appendChild(weekdayCell);
          weekdays.appendChild(weekdayRow);
        }
        table.appendChild(weekdays);
				
        
        // Building the table        
        let doseCounter = 0;
        let doseIteration = 0;
        
        while (currentDate <= endDate) {
          if (weeklyDisplay=="weekstarting"){
            // Table Header (Week Start)
            let thead = document.createElement("thead");
            let headerRow = document.createElement("tr");
            let headerCell = document.createElement("th");
            headerCell.colSpan = 7;
            headerCell.textContent = `Week Starting: ${currentDate.toLocaleDateString(dateLocale,dateLong)}`;
            headerCell.className = "header-week-outline";
            headerRow.appendChild(headerCell);
            thead.appendChild(headerRow);
            table.appendChild(thead);
          }

          let doseClass = "dose-0"; // currently unused
          
          // Table Body (Days)
          let tbody = document.createElement("tbody");
          let row = document.createElement("tr");
					
          for (let i = 0; i < 7; i++) {
            if (doseCounter >= dosePeriod) {
              if (doseIteration < doseIncrementTimes){
              	doseIteration++;
              }
              doseCounter = 0;
              //doseClass = "dose-" + doseIteration.toString();
          	}
            
            let determinedDose = Number(dose) + (Number(doseIncrement) * Number(doseIteration));
            console.log(determinedDose);
            console.log(dose,doseIncrement,doseIteration);
            let cell = document.createElement("td");
            if (currentDate.getDate() === 1){
              cell.textContent = currentDate.toLocaleDateString(dateLocale,dateShortMonth);
            }
            else {
              cell.textContent = currentDate.toLocaleDateString(dateLocale,dateShort);
            }
            let doseIcon = document.createElement("span");
            // Only add dosage text if there actually is a dose specified
            if (determinedDose > 0) {
            	doseIcon.textContent = ` | ${determinedDose}mg`;
            }
            doseIcon.className = doseClass;
            doseCounter++;
            cell.appendChild(doseIcon);
            row.appendChild(cell);
						
            // Move to next day
            currentDate.setDate(currentDate.getDate() + 1);
						
            // Stop if we exceed the end date
            if (currentDate > endDate) break;
          }
					
          tbody.appendChild(row);
          table.appendChild(tbody);
          container.appendChild(table);
        }
      }
			
      function generateFromInputs() {
        // date inputs
        //document.getElementById("start-date").value = new Date();
        const startDateInput = document.getElementById("start-date").value;
        const endDateInput = document.getElementById("end-date").value;
        const dateLocaleInput = document.getElementById("date-locale").value;
        const weeklyDisplayInput = document.getElementById("weekdisplay-options").value;
        
        // dosage inputs
        const doseInput = document.getElementById("dose").value;
        const doseIncrementInput = document.getElementById("dose-increment").value;
        
        // dosage time inputs
        const doseIncrementTimesInput = document.getElementById("dose-increment-times").value;
        const dosePeriodInput = document.getElementById("dose-period").value;
				
        if (!startDateInput || !endDateInput) {
          alert("Please select both start and end dates.");
          return;
        }
        
        const dose = doseInput || 0;
        const doseIncrement = doseIncrementInput || 0;
        const doseIncrementTimes = doseIncrementTimesInput || 0;
        const dosePeriod = dosePeriodInput || 0;
        
        /*if (!doseInput) {
          dose = doseInput;
        }
				
        if (!doseIncrementInput) {
          doseIncrement = doseIncrementInput;
        }
        
        if (!doseIncrementTimes) {
          doseIncrementTimes = doseIncrementTimesInput
        }
        
        if (!dosePeriodInput) {
          dosePeriod = dosePeriodInput;
        }*/
        
        const startDate = new Date(startDateInput);
        const endDate = new Date(endDateInput);
        const dateLocale = dateLocaleInput;
        const weeklyDisplay = weeklyDisplayInput;

        if (startDate > endDate) {
          alert("Start date must be before the end date.");
          return;
        }
				
        generateWeeklyTables(startDate, endDate, dateLocale, weeklyDisplay, dose, doseIncrement, doseIncrementTimes, dosePeriod);
      }
    </script>
    
  </body>
</html>
